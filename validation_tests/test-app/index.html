<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heisenberg Validation Test App</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .hidden { display: none; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1 data-testid="app-title">Heisenberg Validation Test App</h1>
  <p>This app contains intentionally problematic behaviors for testing Heisenberg.</p>

  <!-- Section 1: Timing Issues -->
  <div class="section" data-testid="timing-section">
    <h2>Timing Tests</h2>
    <button data-testid="slow-button" onclick="slowAction()">
      Slow Action (variable delay)
    </button>
    <button data-testid="delayed-element-trigger" onclick="showDelayedElement()">
      Show Delayed Element
    </button>
    <div id="delayed-element" class="hidden result" data-testid="delayed-element">
      I appeared after a delay!
    </div>
    <div id="slow-result" class="result hidden" data-testid="slow-result"></div>
  </div>

  <!-- Section 2: DOM Changes -->
  <div class="section" data-testid="dom-section">
    <h2>DOM Manipulation Tests</h2>
    <button data-testid="remove-self-button" onclick="removeSelf(this)">
      Click me (I'll disappear!)
    </button>
    <button data-testid="replace-button" onclick="replaceButton()">
      Replace Me
    </button>
    <div id="dom-result" class="result hidden" data-testid="dom-result"></div>
  </div>

  <!-- Section 3: Network/API Tests -->
  <div class="section" data-testid="network-section">
    <h2>Network Tests</h2>
    <button data-testid="api-call-button" onclick="makeApiCall()">
      Make API Call
    </button>
    <button data-testid="race-condition-button" onclick="triggerRaceCondition()">
      Trigger Race Condition
    </button>
    <div id="api-result" class="result hidden" data-testid="api-result"></div>
  </div>

  <!-- Section 4: Assertion Tests -->
  <div class="section" data-testid="assertion-section">
    <h2>Assertion Tests</h2>
    <input type="text" data-testid="counter-input" id="counter-input" value="0" readonly>
    <button data-testid="increment-button" onclick="incrementCounter()">
      Increment
    </button>
    <button data-testid="random-value-button" onclick="setRandomValue()">
      Set Random Value
    </button>
    <div data-testid="computed-value" id="computed-value">Computed: 0</div>
  </div>

  <script>
    // Timing: Variable delay (sometimes times out)
    function slowAction() {
      const delay = Math.random() * 6000; // 0-6 seconds (may exceed 5s timeout)
      const resultEl = document.getElementById('slow-result');
      resultEl.textContent = 'Processing...';
      resultEl.classList.remove('hidden');

      setTimeout(() => {
        resultEl.textContent = `Completed after ${Math.round(delay)}ms`;
        resultEl.classList.add('success');
      }, delay);
    }

    // Timing: Show element after variable delay
    function showDelayedElement() {
      const delay = Math.random() * 4000 + 1000; // 1-5 seconds
      setTimeout(() => {
        document.getElementById('delayed-element').classList.remove('hidden');
      }, delay);
    }

    // DOM: Button removes itself on click
    function removeSelf(button) {
      button.remove();
      const result = document.getElementById('dom-result');
      result.textContent = 'Button was removed!';
      result.classList.remove('hidden');
    }

    // DOM: Button is replaced with new element
    function replaceButton() {
      const button = document.querySelector('[data-testid="replace-button"]');
      const newButton = document.createElement('button');
      newButton.setAttribute('data-testid', 'replaced-button');
      newButton.textContent = 'I am the replacement!';
      button.parentNode.replaceChild(newButton, button);
    }

    // Network: Simulated API call with random failure
    async function makeApiCall() {
      const resultEl = document.getElementById('api-result');
      resultEl.textContent = 'Loading...';
      resultEl.classList.remove('hidden', 'error', 'success');

      // Simulate network delay
      await new Promise(r => setTimeout(r, Math.random() * 2000));

      // Random failure
      if (Math.random() < 0.5) {
        resultEl.textContent = 'Error: API request failed (500)';
        resultEl.classList.add('error');
      } else {
        resultEl.textContent = 'Success: Data loaded';
        resultEl.classList.add('success');
      }
    }

    // Network: Race condition - two operations that must complete in order
    let raceState = { step1: false, step2: false };

    function triggerRaceCondition() {
      raceState = { step1: false, step2: false };
      const resultEl = document.getElementById('api-result');
      resultEl.classList.remove('hidden', 'error', 'success');

      // Step 1: Variable delay
      setTimeout(() => {
        raceState.step1 = true;
        checkRaceResult();
      }, Math.random() * 1000);

      // Step 2: Fixed delay - sometimes finishes before step 1
      setTimeout(() => {
        raceState.step2 = true;
        checkRaceResult();
      }, 500);
    }

    function checkRaceResult() {
      const resultEl = document.getElementById('api-result');
      if (raceState.step1 && raceState.step2) {
        // Check if order was correct
        resultEl.textContent = 'Race completed';
        resultEl.classList.add('success');
      }
    }

    // Assertion: Counter with off-by-one bug
    let counter = 0;

    function incrementCounter() {
      // Bug: Sometimes increments by 2 instead of 1
      const increment = Math.random() < 0.3 ? 2 : 1;
      counter += increment;
      document.getElementById('counter-input').value = counter;
      updateComputed();
    }

    function setRandomValue() {
      counter = Math.floor(Math.random() * 100);
      document.getElementById('counter-input').value = counter;
      updateComputed();
    }

    function updateComputed() {
      // Bug: Sometimes shows wrong computed value
      const displayed = Math.random() < 0.2 ? counter - 1 : counter;
      document.getElementById('computed-value').textContent = `Computed: ${displayed}`;
    }
  </script>
</body>
</html>
