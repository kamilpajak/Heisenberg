name: Real-World Validation

on:
  schedule:
    # Run every Monday at 6:00 UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      run_live:
        description: 'Run live validation against real repos'
        required: false
        default: 'true'
        type: boolean

jobs:
  validate-fixtures:
    name: Validate Fixtures
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run fixture validation tests
        run: |
          source .venv/bin/activate
          pytest tests/test_real_world_fixtures.py -v --tb=short

      - name: Write summary
        run: |
          echo "## Fixture Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All real-world fixtures validated successfully" >> $GITHUB_STEP_SUMMARY

  validate-live:
    name: Validate Live Repos
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_live == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Fetch and validate Cal.com
        id: calcom
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source .venv/bin/activate
          echo "Fetching latest Playwright report from Cal.com..."
          heisenberg fetch-github --repo calcom/cal.com --output calcom-report.json || echo "No report available"
          if [ -f calcom-report.json ]; then
            echo "calcom_found=true" >> $GITHUB_OUTPUT
            heisenberg analyze --report calcom-report.json --output-format json > calcom-analysis.json || true
          else
            echo "calcom_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Fetch and validate Grafana
        id: grafana
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source .venv/bin/activate
          echo "Fetching latest Playwright report from Grafana..."
          heisenberg fetch-github --repo grafana/grafana --output grafana-report.json || echo "No report available"
          if [ -f grafana-report.json ]; then
            echo "grafana_found=true" >> $GITHUB_OUTPUT
            heisenberg analyze --report grafana-report.json --output-format json > grafana-analysis.json || true
          else
            echo "grafana_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Write summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## Live Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Cal.com" >> $GITHUB_STEP_SUMMARY
          if [ -f calcom-analysis.json ]; then
            echo "✅ Report fetched and analyzed" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat calcom-analysis.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No report available (artifacts may have expired)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Grafana" >> $GITHUB_STEP_SUMMARY
          if [ -f grafana-analysis.json ]; then
            echo "✅ Report fetched and analyzed" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat grafana-analysis.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No report available (artifacts may have expired)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-reports
          path: |
            *-report.json
            *-analysis.json
          if-no-files-found: ignore
          retention-days: 30

  validate-with-ai:
    name: Validate with AI Analysis
    runs-on: ubuntu-latest
    needs: validate-fixtures
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_live == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run AI analysis on fixtures
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source .venv/bin/activate

          echo "## AI Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for fixture in tests/fixtures/real-world/**/*.json; do
            echo "Analyzing: $fixture"
            echo "### $(basename $fixture)" >> $GITHUB_STEP_SUMMARY

            if [ -n "$ANTHROPIC_API_KEY" ]; then
              heisenberg analyze --report "$fixture" --ai-analysis --output-format json > /tmp/analysis.json 2>&1 || true
              if [ -f /tmp/analysis.json ]; then
                echo '```json' >> $GITHUB_STEP_SUMMARY
                cat /tmp/analysis.json >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              else
                echo "⚠️ Analysis failed" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "⚠️ No API key configured" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
          done
