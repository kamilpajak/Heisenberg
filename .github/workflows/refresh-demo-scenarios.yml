name: Refresh Demo Scenarios

on:
  schedule:
    # Run every Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      max_new_scenarios:
        description: 'Maximum number of new scenarios to freeze'
        required: false
        default: '3'
      force_refresh:
        description: 'Force refresh even if no stale scenarios'
        required: false
        type: boolean
        default: false

env:
  SCENARIOS_DIR: playground/scenarios
  PYTHON_VERSION: '3.12'

jobs:
  validate:
    name: Validate Existing Scenarios
    runs-on: ubuntu-latest
    outputs:
      stale_count: ${{ steps.validate.outputs.stale_count }}
      invalid_count: ${{ steps.validate.outputs.invalid_count }}
      needs_refresh: ${{ steps.check.outputs.needs_refresh }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Heisenberg
        run: pip install -e .

      - name: Create scenarios directory if missing
        run: mkdir -p ${{ env.SCENARIOS_DIR }}

      - name: Validate scenarios
        id: validate
        run: |
          # Run validation and capture output
          OUTPUT=$(heisenberg validate-scenarios ${{ env.SCENARIOS_DIR }} --json 2>/dev/null || echo '{"summary":{"stale":0,"invalid":0}}')

          STALE=$(echo "$OUTPUT" | jq -r '.summary.stale // 0')
          INVALID=$(echo "$OUTPUT" | jq -r '.summary.invalid // 0')

          echo "stale_count=$STALE" >> $GITHUB_OUTPUT
          echo "invalid_count=$INVALID" >> $GITHUB_OUTPUT

          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- Stale scenarios: $STALE" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid scenarios: $INVALID" >> $GITHUB_STEP_SUMMARY

      - name: Check if refresh needed
        id: check
        run: |
          STALE=${{ steps.validate.outputs.stale_count }}
          INVALID=${{ steps.validate.outputs.invalid_count }}
          FORCE=${{ inputs.force_refresh || 'false' }}

          if [[ "$FORCE" == "true" ]] || [[ "$STALE" -gt 0 ]] || [[ "$INVALID" -gt 0 ]]; then
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            echo "Refresh needed: force=$FORCE, stale=$STALE, invalid=$INVALID"
          else
            echo "needs_refresh=false" >> $GITHUB_OUTPUT
            echo "No refresh needed"
          fi

  discover:
    name: Discover New Candidates
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.needs_refresh == 'true'
    outputs:
      candidates_found: ${{ steps.discover.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -e .

      - name: Discover candidate projects
        id: discover
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/discover_projects.py --limit 20 --output /tmp/candidates.json

          # Count compatible candidates
          COUNT=$(jq '[.[] | select(.compatible == true)] | length' /tmp/candidates.json)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          echo "### Discovery Results" >> $GITHUB_STEP_SUMMARY
          echo "Found $COUNT compatible projects" >> $GITHUB_STEP_SUMMARY

      - name: Upload candidates
        uses: actions/upload-artifact@v4
        with:
          name: candidates
          path: /tmp/candidates.json
          retention-days: 1

  freeze-and-analyze:
    name: Freeze & Analyze Scenarios
    runs-on: ubuntu-latest
    needs: [validate, discover]
    if: needs.discover.outputs.candidates_found > 0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Heisenberg
        run: pip install -e .

      - name: Download candidates
        uses: actions/download-artifact@v4
        with:
          name: candidates
          path: /tmp

      - name: Create scenarios directory
        run: mkdir -p ${{ env.SCENARIOS_DIR }}

      - name: Freeze new scenarios
        id: freeze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAX_NEW=${{ inputs.max_new_scenarios || '3' }}
          FROZEN=0

          # Get compatible candidates sorted by stars
          CANDIDATES=$(jq -r '[.[] | select(.compatible == true)] | sort_by(-.stars) | .[].repo' /tmp/candidates.json)

          for REPO in $CANDIDATES; do
            if [[ $FROZEN -ge $MAX_NEW ]]; then
              echo "Reached max new scenarios ($MAX_NEW)"
              break
            fi

            # Check if we already have this repo (any run)
            REPO_SLUG=$(echo "$REPO" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
            if ls ${{ env.SCENARIOS_DIR }}/${REPO_SLUG}-* 1>/dev/null 2>&1; then
              echo "Skipping $REPO (already have scenario)"
              continue
            fi

            echo "Freezing scenario for $REPO..."
            if heisenberg freeze -r "$REPO" --output ${{ env.SCENARIOS_DIR }} 2>/dev/null; then
              FROZEN=$((FROZEN + 1))
              echo "Successfully frozen $REPO"
            else
              echo "Failed to freeze $REPO (likely no valid artifacts)"
            fi
          done

          echo "frozen_count=$FROZEN" >> $GITHUB_OUTPUT
          echo "### Freeze Results" >> $GITHUB_STEP_SUMMARY
          echo "Frozen $FROZEN new scenarios" >> $GITHUB_STEP_SUMMARY

      - name: Analyze new scenarios
        id: analyze
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          ANALYZED=0
          FAILED=0

          # Find scenarios without diagnosis.json
          for SCENARIO_DIR in ${{ env.SCENARIOS_DIR }}/*/; do
            if [[ ! -f "${SCENARIO_DIR}diagnosis.json" ]] && [[ -f "${SCENARIO_DIR}report.json" ]]; then
              SCENARIO_ID=$(basename "$SCENARIO_DIR")
              echo "Analyzing $SCENARIO_ID..."

              if heisenberg analyze-scenario "$SCENARIO_DIR" -p google 2>/dev/null; then
                ANALYZED=$((ANALYZED + 1))
                echo "Successfully analyzed $SCENARIO_ID"
              else
                FAILED=$((FAILED + 1))
                echo "Failed to analyze $SCENARIO_ID"
              fi
            fi
          done

          echo "analyzed_count=$ANALYZED" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT

          echo "### Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "- Analyzed: $ANALYZED" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY

      - name: Generate manifest
        run: |
          heisenberg generate-manifest ${{ env.SCENARIOS_DIR }} -o ${{ env.SCENARIOS_DIR }}/manifest.json

          # Show manifest stats
          echo "### Manifest Generated" >> $GITHUB_STEP_SUMMARY
          jq '.stats' ${{ env.SCENARIOS_DIR }}/manifest.json >> $GITHUB_STEP_SUMMARY

      - name: Upload scenarios
        uses: actions/upload-artifact@v4
        with:
          name: scenarios
          path: ${{ env.SCENARIOS_DIR }}
          retention-days: 7

  commit:
    name: Commit Changes
    runs-on: ubuntu-latest
    needs: freeze-and-analyze
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download scenarios
        uses: actions/download-artifact@v4
        with:
          name: scenarios
          path: ${{ env.SCENARIOS_DIR }}

      - name: Check for changes
        id: changes
        run: |
          git add ${{ env.SCENARIOS_DIR }}
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add ${{ env.SCENARIOS_DIR }}
          git commit -m "chore: refresh demo scenarios [skip ci]"
          git push

      - name: Summary
        run: |
          echo "### Commit Status" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "No changes to commit" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup-stale:
    name: Cleanup Stale Scenarios
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.stale_count > 0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Heisenberg
        run: pip install -e .

      - name: Remove stale scenarios
        run: |
          # Get list of stale scenarios
          STALE=$(heisenberg validate-scenarios ${{ env.SCENARIOS_DIR }} --json | \
                  jq -r '.results[] | select(.status == "stale") | .scenario_id')

          for SCENARIO_ID in $STALE; do
            SCENARIO_PATH="${{ env.SCENARIOS_DIR }}/$SCENARIO_ID"
            if [[ -d "$SCENARIO_PATH" ]]; then
              echo "Removing stale scenario: $SCENARIO_ID"
              rm -rf "$SCENARIO_PATH"
            fi
          done

          echo "### Cleanup Results" >> $GITHUB_STEP_SUMMARY
          echo "Removed stale scenarios" >> $GITHUB_STEP_SUMMARY

      - name: Commit cleanup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add ${{ env.SCENARIOS_DIR }}
          if ! git diff --staged --quiet; then
            git commit -m "chore: remove stale demo scenarios [skip ci]"
            git push
          fi
