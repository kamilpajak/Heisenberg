name: Refresh Demo Cases

on:
  schedule:
    # Run every Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      max_new_cases:
        description: 'Maximum number of new cases to freeze'
        required: false
        default: '3'
      force_refresh:
        description: 'Force refresh even if no stale cases'
        required: false
        type: boolean
        default: false

env:
  CASES_DIR: playground/public/demo-cases
  PYTHON_VERSION: '3.12'

permissions:
  contents: write

jobs:
  validate:
    name: Validate Existing Cases
    runs-on: ubuntu-latest
    outputs:
      stale_count: ${{ steps.validate.outputs.stale_count }}
      invalid_count: ${{ steps.validate.outputs.invalid_count }}
      needs_refresh: ${{ steps.check.outputs.needs_refresh }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Heisenberg
        run: pip install -e ".[backend]"

      - name: Create cases directory if missing
        run: mkdir -p ${{ env.CASES_DIR }}

      - name: Validate cases
        id: validate
        run: |
          # Run validation (may return exit code 1 if invalid cases exist)
          set +e
          OUTPUT=$(heisenberg validate-cases ${{ env.CASES_DIR }} --json 2>/dev/null)
          EXIT_CODE=$?
          set -e

          # Use fallback only if command completely failed (no JSON output)
          if [ -z "$OUTPUT" ] || ! echo "$OUTPUT" | jq -e '.summary' > /dev/null 2>&1; then
            OUTPUT='{"summary":{"stale":0,"invalid":0}}'
          fi

          STALE=$(echo "$OUTPUT" | jq -r '.summary.stale // 0')
          INVALID=$(echo "$OUTPUT" | jq -r '.summary.invalid // 0')

          echo "stale_count=$STALE" >> $GITHUB_OUTPUT
          echo "invalid_count=$INVALID" >> $GITHUB_OUTPUT

          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- Stale cases: $STALE" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid cases: $INVALID" >> $GITHUB_STEP_SUMMARY

      - name: Check if refresh needed
        id: check
        run: |
          STALE=${{ steps.validate.outputs.stale_count }}
          INVALID=${{ steps.validate.outputs.invalid_count }}
          FORCE=${{ inputs.force_refresh || 'false' }}

          if [[ "$FORCE" == "true" ]] || [[ "$STALE" -gt 0 ]] || [[ "$INVALID" -gt 0 ]]; then
            echo "needs_refresh=true" >> $GITHUB_OUTPUT
            echo "Refresh needed: force=$FORCE, stale=$STALE, invalid=$INVALID"
          else
            echo "needs_refresh=false" >> $GITHUB_OUTPUT
            echo "No refresh needed"
          fi

  discover:
    name: Discover New Sources
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.needs_refresh == 'true'
    outputs:
      sources_found: ${{ steps.discover.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -e .

      - name: Discover source projects
        id: discover
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          python scripts/discover_projects.py --limit 20 --output /tmp/sources.json

          # Count compatible sources
          COUNT=$(jq '[.[] | select(.compatible == true)] | length' /tmp/sources.json)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          echo "### Discovery Results" >> $GITHUB_STEP_SUMMARY
          echo "Found $COUNT compatible projects" >> $GITHUB_STEP_SUMMARY

      - name: Upload sources
        uses: actions/upload-artifact@v4
        with:
          name: sources
          path: /tmp/sources.json
          retention-days: 1

  freeze-and-analyze:
    name: Freeze & Analyze Cases
    runs-on: ubuntu-latest
    needs: [validate, discover]
    if: needs.discover.outputs.sources_found > 0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Heisenberg
        run: pip install -e ".[backend]"

      - name: Download sources
        uses: actions/download-artifact@v4
        with:
          name: sources
          path: /tmp

      - name: Create cases directory
        run: mkdir -p ${{ env.CASES_DIR }}

      - name: Freeze new cases
        id: freeze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAX_NEW=${{ inputs.max_new_cases || '3' }}
          FROZEN=0

          # Get compatible sources sorted by stars
          SOURCES=$(jq -r '[.[] | select(.compatible == true)] | sort_by(-.stars) | .[].repo' /tmp/sources.json)

          for REPO in $SOURCES; do
            if [[ $FROZEN -ge $MAX_NEW ]]; then
              echo "Reached max new cases ($MAX_NEW)"
              break
            fi

            # Check if we already have this repo (any run)
            REPO_SLUG=$(echo "$REPO" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
            if ls ${{ env.CASES_DIR }}/${REPO_SLUG}-* 1>/dev/null 2>&1; then
              echo "Skipping $REPO (already have case)"
              continue
            fi

            echo "Freezing case for $REPO..."
            if heisenberg freeze -r "$REPO" --output ${{ env.CASES_DIR }} 2>/dev/null; then
              FROZEN=$((FROZEN + 1))
              echo "Successfully frozen $REPO"
            else
              echo "Failed to freeze $REPO (likely no valid artifacts)"
            fi
          done

          echo "frozen_count=$FROZEN" >> $GITHUB_OUTPUT
          echo "### Freeze Results" >> $GITHUB_STEP_SUMMARY
          echo "Frozen $FROZEN new cases" >> $GITHUB_STEP_SUMMARY

      - name: Analyze new cases
        id: analyze
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          ANALYZED=0
          FAILED=0

          # Find cases without diagnosis.json
          for CASE_DIR in ${{ env.CASES_DIR }}/*/; do
            if [[ ! -f "${CASE_DIR}diagnosis.json" ]] && [[ -f "${CASE_DIR}report.json" ]]; then
              CASE_ID=$(basename "$CASE_DIR")
              echo "Analyzing $CASE_ID..."

              if heisenberg analyze-case "$CASE_DIR" -p google; then
                ANALYZED=$((ANALYZED + 1))
                echo "Successfully analyzed $CASE_ID"
              else
                FAILED=$((FAILED + 1))
                echo "Failed to analyze $CASE_ID"
              fi
            fi
          done

          echo "analyzed_count=$ANALYZED" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT

          echo "### Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "- Analyzed: $ANALYZED" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY

      - name: Generate manifest
        run: |
          heisenberg generate-manifest ${{ env.CASES_DIR }} -o ${{ env.CASES_DIR }}/manifest.json

          # Show manifest stats
          echo "### Manifest Generated" >> $GITHUB_STEP_SUMMARY
          jq '.stats' ${{ env.CASES_DIR }}/manifest.json >> $GITHUB_STEP_SUMMARY

      - name: Upload cases
        uses: actions/upload-artifact@v4
        with:
          name: cases
          path: ${{ env.CASES_DIR }}
          retention-days: 7

  commit:
    name: Commit Changes
    runs-on: ubuntu-latest
    needs: freeze-and-analyze
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download cases
        uses: actions/download-artifact@v4
        with:
          name: cases
          path: ${{ env.CASES_DIR }}

      - name: Check for changes
        id: changes
        run: |
          git add ${{ env.CASES_DIR }}
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add ${{ env.CASES_DIR }}
          git commit -m "chore: refresh demo cases [skip ci]"
          git pull --rebase origin main
          git push

      - name: Summary
        run: |
          echo "### Commit Status" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "No changes to commit" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup-stale:
    name: Cleanup Stale Cases
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.stale_count > 0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Heisenberg
        run: pip install -e ".[backend]"

      - name: Remove stale cases
        run: |
          # Get list of stale cases
          STALE=$(heisenberg validate-cases ${{ env.CASES_DIR }} --json | \
                  jq -r '.results[] | select(.status == "stale") | .case_id')

          for CASE_ID in $STALE; do
            CASE_PATH="${{ env.CASES_DIR }}/$CASE_ID"
            if [[ -d "$CASE_PATH" ]]; then
              echo "Removing stale case: $CASE_ID"
              rm -rf "$CASE_PATH"
            fi
          done

          echo "### Cleanup Results" >> $GITHUB_STEP_SUMMARY
          echo "Removed stale cases" >> $GITHUB_STEP_SUMMARY

      - name: Commit cleanup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add ${{ env.CASES_DIR }}
          if ! git diff --staged --quiet; then
            git commit -m "chore: remove stale demo cases [skip ci]"
            git pull --rebase origin main
            git push
          fi
